<!DOCTYPE html>
<html lang="en-us">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <title>Automatically Scaling Down Lambda Provisioned Concurrency | Roopesh V S</title>

    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">    
<meta name="viewport" content="width=device-width,minimum-scale=1">
<meta name="description" content="If you are using AWS Lambdas to serve real-time traffic, and if your lambda initialization times are high, you might want to minimise the response time, and one of the options to do that is to utilise provisioned concurrency. Provisioned Concurrency is the number of pre-initialized execution environments allocated to your lambda function.
A constant Provisioned Concurrenct capacity of 200 for a 512 MB lambda for a month will cost ~1,116 USD!">
<meta name="generator" content="Hugo 0.123.6">


  <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">


<link rel="stylesheet" href="/css/style.css">



<link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon" />

 
  
<script async src="https://www.googletagmanager.com/gtag/js?id=G-JBPFCP1590"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-JBPFCP1590', { 'anonymize_ip': false });
}
</script>








  </head>

  <body>
    <nav class="navigation">
	
		<a href="/"> <span class="arrow">←</span>Home</a>
	
	<a href="/posts">Archive</a>
	<a href="/tags">Tags</a>
	<a href="/about">About</a>

	

	
	  <a class="button" href="http://localhost:1313/index.xml">Subscribe</a>
	
</nav>


    <main class="main">
      

<section id="single">
    <h1 class="title">Automatically Scaling Down Lambda Provisioned Concurrency</h1>

    <div class="tip">
        <time datetime="2024-03-01 00:00:00 &#43;0000 UTC">Mar 1, 2024</time>
        <span class="split">
          ·
        </span>
        <span>
          894 words
        </span>
        <span class="split">
          ·
        </span>
        <span>
          5 minute read
        </span>
    </div>

    
    
        
  


    


    <div class="content">
      <p>If you are using <a href="https://aws.amazon.com/lambda/" target="_blank" rel="noopener">AWS Lambdas</a> to serve real-time traffic, and if your lambda initialization times are high, you might want to minimise the response time, and one of the options to do that is to utilise provisioned concurrency. <a href="https://aws.amazon.com/blogs/aws/new-provisioned-concurrency-for-lambda-functions/" target="_blank" rel="noopener">Provisioned Concurrency</a> is the number of pre-initialized execution environments allocated to your lambda function.</p>
<p>A constant Provisioned Concurrenct capacity of 200 for a 512 MB lambda for a month will cost <code>~1,116 USD</code>! This is in addition to the pricing for requests and duration. AWS gives the option to scale the provisioned concurrency of lambda based on schedule and demand. We allowed the provisioned concurrency of our lambdas to scale based on the <code>ProvisionedConcurrencyUtilization</code> metric.</p>
<blockquote>
<p>Note that at the time of writing this, <strong>provisioned concurrency scaling</strong> is not available from the AWS console but only via APIs, SDKs, or CLIs.</p>
</blockquote>
<p>The initialisation time for one of our lambdas is over 40 seconds. It has to load in a few different ML models as pickled python objects. So, without an available pre-initialised lambda instance in place, a request coming through the API Gateway will definitely fail because of the API Gateway timeout of 29s.</p>
<p>We set the provisioned concurrency capacity to scale from a minimum of 10 to a maximum of 200. This means at all times there will be atleast 10 pre-initialised lambda instances waiting to serve requests which can go upto 200 pre-initialised instances. We ran a quick load test and the provisioned concurrency scaled up well and it helped in keeping the response time of the lambda to be less than 100 ms throughout. Even with 30K requests a minute, only about 100 provisioned concurrency capacity was required.</p>
<p><strong>Everything looks good, so what is the catch?</strong> As nice as it was to see the provisioned concurrency scaling up to 100 to handle the traffic without any errors, it did not come back down automatically! This was alarming. We noticed this only a good 48 hours later and was costing us even when there were no requests. Quickly ran an AWS CLI command on loop for all lambdas to bring down their provision concurrency to the minimum value.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>aws lambda put-provisioned-concurrency-config <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    --function-name generic-function-name <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    --qualifier latest <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    --provisioned-concurrent-executions <span style="color:#666">10</span>
</span></span></code></pre></div><p><strong>So, why did the provisioned concurrency of the lambdas not come back down when there were no requests?</strong> Provisioned Concurrency scaling works with Cloudwatch Alarms that are created and managed by AWS when we create the scaling policy. When taking a look at the alarms, it did not set off the action to Scale Down as the Alarm for Low Provisioned Concurrency Utilization never triggered because of <code>insufficient data</code>. Since there were no requests now and provisioned concurrency is not being utilised, the alarms transitioned to the <code>insufficient data</code> state. There is an option in the Cloudwatch Alarms to <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/AlarmThatSendsEmail.html#alarms-and-missing-data" target="_blank" rel="noopener">set how to treat missing data</a>. This problem could have been solved by using this config to treat missing data as <code>breaching</code> instead of the default <code>missing</code>. Unfortunately, this configuration option is not available when creating an autoscaling policy only when creating an alarm directly. I thought about editing the alarm directly, but <a href="https://docs.aws.amazon.com/autoscaling/ec2/userguide/as-scaling-target-tracking.html#target-tracking-considerations" target="_blank" rel="noopener">AWS recommends not to edit Cloudwatch Alarms created with these auto scaling target tracking policies</a>.</p>
<p>After hours of googling the issue, surprisingly no one the internet seem to have talked much about it! I widened my search, now looking for cases on what people do when the CloudWatch alarm is not getting triggered because of insufficient data when there are no metrics to be reported. I came across a <a href="https://stackoverflow.com/a/66331752" target="_blank" rel="noopener">Stack Overflow answer</a> which suggested using the <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/using-metric-math.html" target="_blank" rel="noopener">FILL function</a> to create a new metric which will have <code>0</code> whenever the original metric responds with <code>insufficient data</code>, and then use the new metric in the autoscaling policy. I did not know about the possibility of using Math Expressions to create new metrics before. This idea was promising.</p>
<p>Created the following Target Tracking policy JSON which did exactly that:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JSON" data-lang="JSON"><span style="display:flex;"><span><span style="color:#080;font-style:italic">// target-tracking.json
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>{
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;CustomizedMetricSpecification&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#008000;font-weight:bold">&#34;Metrics&#34;</span>: [
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#008000;font-weight:bold">&#34;Label&#34;</span>: <span style="color:#b44">&#34;ProvisionedConcurrencyUtilization&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#008000;font-weight:bold">&#34;Id&#34;</span>: <span style="color:#b44">&#34;m1&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#008000;font-weight:bold">&#34;MetricStat&#34;</span>: {
</span></span><span style="display:flex;"><span>                    <span style="color:#008000;font-weight:bold">&#34;Metric&#34;</span>: {
</span></span><span style="display:flex;"><span>                        <span style="color:#008000;font-weight:bold">&#34;MetricName&#34;</span>: <span style="color:#b44">&#34;ProvisionedConcurrencyUtilization&#34;</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#008000;font-weight:bold">&#34;Namespace&#34;</span>: <span style="color:#b44">&#34;AWS/Lambda&#34;</span>,
</span></span><span style="display:flex;"><span>                        <span style="color:#008000;font-weight:bold">&#34;Dimensions&#34;</span>: [
</span></span><span style="display:flex;"><span>                            {
</span></span><span style="display:flex;"><span>                                <span style="color:#008000;font-weight:bold">&#34;Name&#34;</span>: <span style="color:#b44">&#34;FunctionName&#34;</span>,
</span></span><span style="display:flex;"><span>                                <span style="color:#008000;font-weight:bold">&#34;Value&#34;</span>: <span style="color:#b44">&#34;generic-function-name&#34;</span>
</span></span><span style="display:flex;"><span>                            },
</span></span><span style="display:flex;"><span>                            {
</span></span><span style="display:flex;"><span>                                <span style="color:#008000;font-weight:bold">&#34;Name&#34;</span>: <span style="color:#b44">&#34;Resource&#34;</span>,
</span></span><span style="display:flex;"><span>                                <span style="color:#008000;font-weight:bold">&#34;Value&#34;</span>: <span style="color:#b44">&#34;generic-function-name:latest&#34;</span>
</span></span><span style="display:flex;"><span>                            }
</span></span><span style="display:flex;"><span>                        ]
</span></span><span style="display:flex;"><span>                    },
</span></span><span style="display:flex;"><span>                    <span style="color:#008000;font-weight:bold">&#34;Stat&#34;</span>: <span style="color:#b44">&#34;Maximum&#34;</span>
</span></span><span style="display:flex;"><span>                },
</span></span><span style="display:flex;"><span>                <span style="color:#008000;font-weight:bold">&#34;ReturnData&#34;</span>: <span style="color:#a2f;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#008000;font-weight:bold">&#34;Label&#34;</span>: <span style="color:#b44">&#34;ProvisionedConcurrencyUtilization where Missing Data = 0&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#008000;font-weight:bold">&#34;Id&#34;</span>: <span style="color:#b44">&#34;e1&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#008000;font-weight:bold">&#34;Expression&#34;</span>: <span style="color:#b44">&#34;FILL(m1, 0)&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#008000;font-weight:bold">&#34;ReturnData&#34;</span>: <span style="color:#a2f;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;TargetValue&#34;</span>: <span style="color:#666">0.7</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;ScaleOutCooldown&#34;</span>: <span style="color:#666">60</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;ScaleInCooldown&#34;</span>: <span style="color:#666">60</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;DisableScaleIn&#34;</span>: <span style="color:#a2f;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Ran the following <code>put-scaling-policy</code> AWS CLI command to test the lambda function:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>aws application-autoscaling put-scaling-policy --service-namespace lambda <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    --scalable-dimensionlambda:function:ProvisionedConcurrency <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    --resource-id generic-function-name <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    --policy-name generic-target-tracking-scaling-policy --policy-type TargetTrackingScaling <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    --target-tracking-scaling-policy-configuration file://target-tracking.json
</span></span></code></pre></div><p>Headed over to AWS Cloudwatch Alarms and filtered for <code>generic-function-name</code> and was delighted to see the new metric <code>ProvisionedConcurrencyUtilization where Missing Data = 0</code> populating 0 even when <code>ProvisionedConcurrencyUtilization</code> was returning Insufficient Data. Ran a quick load test again, this time waiting to see what happens when there are no requests, and the alarm went into action as expected and gracefully brought down the provisioned concurrency capacity.</p>
<p>Now that we have confirmed the solution is indeed working, all that was left was updating our terraform lambda module to propagate this change to all lambdas. <a href="https://gist.github.com/roopeshvs/e2a6d8ca10cf7fe5087f3878e6e08882" target="_blank" rel="noopener">Here is a snippet of the terraform resource aws_appautoscaling_policy</a>.</p>
<p>Now, even when there are no requests coming in, the cloudwatch alarm for provisioned concurrency autoscaling will get triggered with the new metric, and the scale down happens automatically. To less cloud bills! 🍻</p>

    </div>

    
    
    
  <div id="comment">
    
    <div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "roopeshvs" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </div>


</section>


    </main>
    
    <footer id="footer">
    
        <div id="social">


    <a class="symbol" href="https://github.com/roopeshvs" rel="me" target="_blank">
        
        <svg fill="#bbbbbb" width="28" height="28"  viewBox="0 0 72 72" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    
    <title>Github</title>
    <desc>Created with Sketch.</desc>
    <defs></defs>
    <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="Social-Icons---Rounded-Black" transform="translate(-264.000000, -939.000000)">
            <g id="Github" transform="translate(264.000000, 939.000000)">
                <path d="M8,72 L64,72 C68.418278,72 72,68.418278 72,64 L72,8 C72,3.581722 68.418278,-8.11624501e-16 64,0 L8,0 C3.581722,8.11624501e-16 -5.41083001e-16,3.581722 0,8 L0,64 C5.41083001e-16,68.418278 3.581722,72 8,72 Z" id="Rounded" fill="#bbbbbb"></path>
                <path d="M35.9985,13 C22.746,13 12,23.7870921 12,37.096644 C12,47.7406712 18.876,56.7718301 28.4145,59.9584121 C29.6145,60.1797862 30.0525,59.4358488 30.0525,58.7973276 C30.0525,58.2250681 30.0315,56.7100863 30.0195,54.6996482 C23.343,56.1558981 21.9345,51.4693938 21.9345,51.4693938 C20.844,48.6864054 19.2705,47.9454799 19.2705,47.9454799 C17.091,46.4500754 19.4355,46.4801943 19.4355,46.4801943 C21.843,46.6503662 23.1105,48.9634994 23.1105,48.9634994 C25.2525,52.6455377 28.728,51.5823398 30.096,50.9649018 C30.3135,49.4077535 30.9345,48.3460615 31.62,47.7436831 C26.2905,47.1352808 20.688,45.0691228 20.688,35.8361671 C20.688,33.2052792 21.6225,31.0547881 23.1585,29.3696344 C22.911,28.7597262 22.0875,26.3110578 23.3925,22.9934585 C23.3925,22.9934585 25.4085,22.3459017 29.9925,25.4632101 C31.908,24.9285993 33.96,24.6620468 36.0015,24.6515052 C38.04,24.6620468 40.0935,24.9285993 42.0105,25.4632101 C46.5915,22.3459017 48.603,22.9934585 48.603,22.9934585 C49.9125,26.3110578 49.089,28.7597262 48.8415,29.3696344 C50.3805,31.0547881 51.309,33.2052792 51.309,35.8361671 C51.309,45.0917119 45.6975,47.1292571 40.3515,47.7256117 C41.2125,48.4695491 41.9805,49.9393525 41.9805,52.1877301 C41.9805,55.4089489 41.9505,58.0067059 41.9505,58.7973276 C41.9505,59.4418726 42.3825,60.1918338 43.6005,59.9554002 C53.13,56.7627944 60,47.7376593 60,37.096644 C60,23.7870921 49.254,13 35.9985,13" fill="#FFFFFF"></path>
            </g>
        </g>
    </g>
</svg>
    </a>

    <a class="symbol" href="https://www.linkedin.com/in/roopesh-vs/" rel="me" target="_blank">
        
        <svg width="28" height="28" fill="#bbbbbb" viewBox="0 0 500 500">
  <g fill="none" fill-rule="evenodd">
    <rect width="500" height="500" fill="#bbbbbb" rx="50"/>
    <path fill="#FFF" d="M154.703 100.183c-19.121 0-34.689 15.565-34.703 34.701 0 19.136 15.568 34.704 34.703 34.704 19.128 0 34.688-15.568 34.688-34.704 0-19.134-15.561-34.701-34.688-34.701zm26.045 83.348h-52.094a4.488 4.488 0 0 0-4.488 4.489v167.675a4.488 4.488 0 0 0 4.488 4.488h52.093a4.49 4.49 0 0 0 4.489-4.488V188.02a4.486 4.486 0 0 0-4.488-4.489zm133.176-1.974c-19.064 0-35.817 5.805-46.04 15.271v-8.808c0-2.48-2.01-4.489-4.489-4.489h-49.971a4.489 4.489 0 0 0-4.489 4.489v167.675a4.488 4.488 0 0 0 4.489 4.488h52.044a4.49 4.49 0 0 0 4.489-4.488v-82.957c0-23.802 4.378-38.555 26.227-38.555 21.526.026 23.137 15.846 23.137 39.977v81.535a4.489 4.489 0 0 0 4.49 4.488h52.068a4.489 4.489 0 0 0 4.488-4.488v-91.977c-.001-38.253-7.553-82.161-66.443-82.161z"/>
  </g>
</svg>

    </a>


</div>

    

    <div class="copyright">
    
        © Copyright 2024 ❤️ Roopesh
    
    </div>

    
</footer>



  </body>
</html>
